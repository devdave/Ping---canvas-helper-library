<!DOCTYPE html>
<html>
    <head>
        <title>Mapping/partitioning</title>
        <script src="/js/jquery.js"></script>
        <!--<script type="text/javascript" src="/js/jquery.jstree.js"></script>-->
        <script src="libs/app.core.js"></script>
        <script src="libs/app.main.js"></script>
        <script src="libs/app.canvas.js"></script>
        <script src="/mapping.js"></script>
    </head>
    <body>
        
        <canvas height="400" width="600" id="mapper"></canvas>
        <div class="statPanel" style="float:right">
            <ol id="wtf"></ol><br/>
            <label>Node list</label>
            <ul id="nodeList"></ul>
        </div>
        <script>
            
            var run = function(){
                stepPos = 12;
                ctx = appLib.$C("mapper");
                map = QuadrantFactory(ctx, stepPos);
                
                function zf( number )
                {
                  var width = 3;
                  width -= number.toString().length;
                  if ( width > 0 )
                  {
                    return new Array( width + (/\./.test( number ) ? 2 : 1) ).join( '0' ) + number;
                  }
                  return number;
                }
                
                function traversal(node, parent){
                        
                        if(this instanceof Quadrant){
                            node = this;
                        }
                        
                        var liNode = "<li>";
                        liNode += "\n " + node.name
                                        + " - "
                                        + node.depth
                                        + "["
                                        + zf(node.x)
                                        + ","
                                        + zf(node.y)
                                        + "] "
                                        + "["
                                        + zf(node.sx)
                                        + ","
                                        + zf(node.sy)
                                        + "]";
                        
                        var temp = node.loop(traversal);
                        if(temp.length > 0){
                            var subTemp = temp.join("\n");
                            
                            liNode += "<ul>" + subTemp + "</ul>";
                        }
                        liNode += "</li>";
                        return liNode;
                    }
                    
                //$(ctx.canvas).mousemove(function mousemove(evt){
                //        //@TODO add a getMouseCoords helper thingy
                //        ctx.globalAlpha = 1;
                //        
                //        var p = [Math.max(0, evt.layerX - evt.currentTarget.offsetLeft), Math.max(0, evt.layerY - evt.currentTarget.offsetTop)];
                //        var qs = map.find(p[0],p[1]);                     
                //        
                //        var highColor = 200;
                //        
                //        try{
                //            $("#wtf").empty().append($("<legend>").text("[" + p[0] + ", " + p[1] + "]"));
                //            for(var cq = 0; cq < qs.length; cq++){
                //                var quad = qs[cq];
                //                ctx.globalAlpha = (100 - (quad.depth*2)) / 100;
                //                var color = "rgb(128,128," + Math.max(10, highColor - (quad.depth * 10)) + ");";
                //                ctx.fillStyle = color;
                //                ctx.render(function(){
                //                            this.fillRect(quad.x, quad.y, quad.sx, quad.sy);
                //                });
                //                text = quad.name + " " + quad.depth + " [" +quad.x + ", " + quad.y + "] - [" + quad.sx + ", " + quad.sy + "] "
                //                                                
                //                $("#wtf").append($("<li>")
                //                                 .text( text ).attr("style", "color:" + color)
                //                                 );                                                       
                //            }
                //        }catch(ex){
                //            console.error(ex);
                //        }
                //        ctx.globalAlpha = 1;
                //        map.render(ctx);
                //        
                //        
                //    });
                
                function placePoint(p){
                    map.add({x:p[0], y:p[1], sx:10, sy:10});

                    ctx.render(function(){
                        map.render(ctx);                            
                    });
                    
                    
                    var list = traversal(map);
                    $("#nodeList").empty();
                    document.getElementById("nodeList").innerHTML = list;
                }
                
                //$(ctx.canvas).mousedown(function mousedown(evt){
                //    var p = [Math.max(0, evt.layerX - evt.currentTarget.offsetLeft), Math.max(0, evt.layerY - evt.currentTarget.offsetTop)];
                //    placePoint(p);                    
                //});
                function ballFactory(maxX, maxY){
                    var ball = {
                    x: Math.random()*maxX
                    ,y:Math.random()*maxY
                    ,dx:Math.random()*5 + 1
                    ,dy:Math.random()*5 + 1
                    };
                    var interval = function (){
                        
                        
                        
                        ball.x += ball.dx;
                        ball.y += ball.dy;
                        if(! appLib.util.inside(ball.x, 0, 600)){
                            ball.dx = -1 * ball.dx;
                        }
                        if(! appLib.util.inside(ball.y, 0, 400)){
                            ball.dy = -1 * ball.dy;
                        }
                        
                        placePoint([ball.x,ball.y]);
                        
                        ctx.fillStyle = "red";
                        ctx.render(function(){                        
                            ctx.fillRect(ball.x,ball.y,10,10);
                            
                        });
                        
                                       
                        
                    }
                    return interval;
                }
                
                var balls = [ballFactory(600,400), ballFactory(600,400), ballFactory(600,400)];
                
                
                function runLogic(){
                    stepPos = 12;
                    ctx = appLib.$C("mapper");
                    delete map;
                    map = QuadrantFactory(ctx, stepPos);
                    
                    ctx.render(function(){
                            ctx.floodFill("white");
                    });
                    for(var i = 0; i < balls.length; i++){
                        balls[i]();
                    }
                    ctx.render(function(){
                        map.render(ctx);
                    })
                }
                
               setInterval(runLogic, 25);
               
               
            };
        
            $(run);
        </script>
        
    </body>
</html>